\documentclass{beamer}
\usetheme{Madrid}
\usecolortheme{default}

\usepackage{amsmath}
\usepackage{booktabs}
\usepackage{xcolor}
\usepackage{listings}

\lstset{
    basicstyle=\ttfamily\small,
    breaklines=true,
    frame=single,
    backgroundcolor=\color{black!5}
}

\definecolor{warn}{RGB}{220,53,69}
\definecolor{note}{RGB}{40,167,69}
\definecolor{codebg}{RGB}{40,40,40}

\newcommand{\warn}[1]{\textcolor{warn}{\textbf{WARNING:} #1}}
\newcommand{\notebox}[1]{\textcolor{note}{\textbf{NOTE:} #1}}
\newcommand{\filepath}[1]{\texttt{#1}}

\title{Fantasy Baseball Draft Tool}
\subtitle{Technical Documentation for AI Handoff}
\author{Claude + Kevin}
\date{February 2026}

\begin{document}

\begin{frame}
\titlepage
\end{frame}

\begin{frame}{Outline}
\tableofcontents
\end{frame}

%=============================================================================
\section{File Structure}
%=============================================================================

\begin{frame}[fragile]{Repository Structure}
\begin{lstlisting}
/home/user/FBB/
|-- draft_tool.html      # Main app (HTML + JS, ~1200 lines)
|-- create_league_stats.py    # Generates hitter CSVs
|-- create_pitching_stats.py  # Generates pitcher CSVs
|-- normalize_pa.py           # Aligns PA across systems
|
|-- DC_Raw_Jan_25.csv         # Depth Charts raw projections
|-- The_Bat_Raw_Jan_25.csv    # The Bat raw projections
|-- The_BatX_Raw_Jan_25.csv   # The BatX raw projections
|
|-- The_Bat_Normalized_PA.csv  # The Bat with DC playing time
|-- The_BatX_Normalized_PA.csv # BatX with DC playing time
|
|-- fantasy_hitters_dc_2026.csv    # Processed DC hitters
|-- fantasy_hitters_thebat_2026.csv
|-- fantasy_hitters_batx_2026.csv
\end{lstlisting}
\end{frame}

\begin{frame}{Data Flow Overview}
\textbf{Pipeline:}
\begin{enumerate}
    \item Raw projections (DC, The Bat, BatX) downloaded from FanGraphs
    \item \filepath{normalize\_pa.py}: Scale The Bat/BatX to use DC playing time
    \item \filepath{create\_league\_stats.py}: Add z-scores, supplement to 600 PA
    \item Output CSVs embedded as JS arrays in \filepath{draft\_tool.html}
\end{enumerate}

\vspace{0.5cm}
\warn{The player data arrays in draft\_tool.html are generated separately. If you regenerate CSVs, you must manually update the JS arrays.}
\end{frame}

%=============================================================================
\section{Key Constants (draft\_tool.html)}
%=============================================================================

\begin{frame}[fragile]{Location: Lines 482-510}
\begin{lstlisting}[language={}]
// Weekly standard deviations from 2024 league data
const HITTING_SD = {
  R: 6.03, HR: 2.93, RBI: 6.72, SB: 2.57,
  SO: 7.45, TB: 15.94, OBP: 0.04, AB: 16.89
};
const PITCHING_SD = {
  L: 1.8346, SV: 1.5362, K: 11.7861, HLD: 1.6383,
  ERA: 1.3141, WHIP: 0.2057, QS: 1.4012, IP: 10.82
};

// League averages (used as opponent baseline)
const HITTING_AVG = {
  R: 28.96, HR: 8.02, RBI: 27.86, SB: 4.74,
  SO: 50.11, TB: 88.87, OBP: 0.32, AB: 208.3
};
\end{lstlisting}

\notebox{These SDs come from 2024 league weekly results. They determine category leverage.}
\end{frame}

\begin{frame}[fragile]{Replacement Level Constants}
\begin{lstlisting}[language={}]
// Hitter replacement (600 PA season totals)
const HITTER_REP = {
  name: 'Replacement', type: 'H', pa: 600,
  r: 73, hr: 20, rbi: 72, so: 134,
  tb: 224, sb: 9, obp: 0.32
};

// RP replacement (per roster slot, weekly)
const RP_REP_PER_SLOT = {
  ip_wk: 2.480, l_wk: 0.1180, sv_wk: 0.1208,
  hld_wk: 0.8484, k_wk: 2.693,
  er_wk: 0.963, wh_wk: 2.852
};

// SP replacement (per start)
const SP_REP_PER_START = {
  ip: 5.5, l: 0.11, qs: 0.45,
  k: 5.0, er: 2.5, wh: 7.0
};
\end{lstlisting}
\end{frame}

\begin{frame}{Where Replacement Rates Come From}
\textbf{Hitter replacement} (defined in \filepath{create\_league\_stats.py}):
\begin{itemize}
    \item Rank all hitters by zTotal using Depth Charts
    \item Take players ranked 155--175 (just beyond 16$\times$9=144 drafted)
    \item Average their per-PA rates
    \item Multiply by 600 PA to get season totals
\end{itemize}

\vspace{0.3cm}
\warn{OBP is hardcoded to 0.320 (league avg) because the cohort's actual OBP (0.324) exceeded it. Replacement should be neutral, not positive.}

\vspace{0.3cm}
\textbf{RP replacement}: Middle relievers who get holds, not saves.

\textbf{SP replacement}: Backend starter (~5.5 IP, ~4.1 ERA per start).
\end{frame}

%=============================================================================
\section{Core Functions (draft\_tool.html)}
%=============================================================================

\begin{frame}[fragile]{normalCDF and winProbability (Lines 580-599)}
\begin{lstlisting}[language={}]
function normalCDF(x) {
  // Abramowitz-Stegun approximation
  const a1=0.254829592, a2=-0.284496736, ...
  const sign = x < 0 ? -1 : 1;
  x = Math.abs(x) / Math.sqrt(2);
  const t = 1.0 / (1.0 + 0.3275911 * x);
  const y = 1 - (((a5*t+a4)*t+a3)*t+a2)*t+a1)*t
            * Math.exp(-x*x);
  return 0.5 * (1.0 + sign * y);
}

function winProbability(myMean, oppMean, sd,
                        lowerIsBetter = false) {
  const z = lowerIsBetter
    ? (oppMean - myMean) / (sd * Math.sqrt(2))
    : (myMean - oppMean) / (sd * Math.sqrt(2));
  return normalCDF(z);
}
\end{lstlisting}
\end{frame}

\begin{frame}{The Win Probability Formula}
\[
P(\text{win}) = \Phi\left(\frac{\mu_{me} - \mu_{opp}}{\sigma \sqrt{2}}\right)
\]

\textbf{Where:}
\begin{itemize}
    \item $\mu_{me}$ = my team's expected weekly total
    \item $\mu_{opp}$ = opponent's expected (uses \texttt{HITTING\_AVG})
    \item $\sigma$ = weekly SD for that category
    \item $\sqrt{2}$ comes from $\text{Var}(X-Y) = 2\sigma^2$
\end{itemize}

\vspace{0.3cm}
\notebox{The $\sqrt{2}$ assumes both teams have same variance. This is a simplification---opponent quality varies---but reasonable.}
\end{frame}

\begin{frame}[fragile]{getHittingProjections (Lines 604-615)}
\begin{lstlisting}[language={}]
function getHittingProjections(teamName) {
  const roster = allTeams[teamName].hitters;
  // Empty slots use HITTER_REP
  const players = roster.map(slot =>
    slot.player || HITTER_REP);

  const proj = {};
  ['r','hr','rbi','sb','so','tb'].forEach(cat => {
    proj[cat.toUpperCase()] = players.reduce(
      (sum, p) => sum + p[cat] / NUM_WEEKS, 0);
  });
  // OBP is average across 9 hitters
  proj['OBP'] = players.reduce(
    (sum, p) => sum + p.obp, 0) / players.length;
  return proj;
}
\end{lstlisting}

\warn{Empty slots auto-fill with HITTER\_REP. This is how marginal value ``vs replacement'' works.}
\end{frame}

\begin{frame}[fragile]{calculateMarginalValue (Lines 724-753)}
\begin{lstlisting}[language={}]
function calculateMarginalValue(player) {
  const team = allTeams['My Team'];
  const currentWins = getExpectedWins('My Team')
                      .wins.TOTAL;

  // Temporarily add player to first empty slot
  if (player.type === 'H') {
    const idx = team.hitters.findIndex(
      s => s.player === null);
    if (idx === -1) return -999; // No empty slot
    team.hitters[idx].player = player;
    newWins = getExpectedWins('My Team').wins.TOTAL;
    team.hitters[idx].player = null; // Restore
  }
  // Similar for SP, RP...

  return newWins - currentWins;
}
\end{lstlisting}

This is \textbf{the core ranking function}. It computes: ``How many expected category wins does this player add?''
\end{frame}

\begin{frame}{Marginal Value Calculation: Step by Step}
\textbf{When roster is empty:}
\begin{enumerate}
    \item \texttt{currentWins} = wins with 9 replacement hitters
    \item Add player to slot 0, recalculate \texttt{newWins}
    \item \texttt{marginalValue = newWins - currentWins}
\end{enumerate}

\vspace{0.3cm}
\textbf{Example: Jos\'{e} Ram\'{i}rez on empty roster}
\begin{itemize}
    \item 9 replacement hitters: expected wins = 2.99/7
    \item 8 replacement + Ram\'{i}rez: expected wins = 3.36/7
    \item Marginal value = 0.378
\end{itemize}

\vspace{0.3cm}
\notebox{Marginal value depends on current roster. As you draft more players, MV changes based on team composition.}
\end{frame}

%=============================================================================
\section{Pitching Projections}
%=============================================================================

\begin{frame}[fragile]{getPitchingProjections (Lines 617-690)}
Key logic for SP slots:
\begin{lstlisting}[language={}]
const SP_SLOTS = 7;
const SP_STARTS_PER_WEEK = 1.1; // per slot

// Drafted SPs contribute their projected stats
sps.forEach(sp => {
  sp_ip += sp.ip_wk;  // Already per-week
  sp_k += sp.k_wk;
  ...
});

// Empty slots filled with replacement
const repSpSlots = SP_SLOTS - sps.length;
sp_ip += repSpSlots * SP_STARTS_PER_WEEK
         * SP_REP_PER_START.ip;
\end{lstlisting}

\warn{SP stats in the PITCHERS array are already scaled to 1.1 starts/week. Don't double-scale.}
\end{frame}

\begin{frame}[fragile]{ERA and WHIP Calculation}
\begin{lstlisting}[language={}]
// Total pitching
const total_ip = sp_ip + rp_ip;
const total_er = sp_er + rp_er;
const total_wh = sp_wh + rp_wh;

return {
  ...
  ERA: total_ip > 0
       ? (total_er * 9 / total_ip) : 4.5,
  WHIP: total_ip > 0
       ? (total_wh / total_ip) : 1.3,
  ...
};
\end{lstlisting}

\notebox{ERA/WHIP are innings-weighted. A reliever pitching 2.5 IP/week has ~6\% weight on team ERA. This is why RP ERA/WHIP contributions are tiny.}
\end{frame}

%=============================================================================
\section{CSV Generation (create\_league\_stats.py)}
%=============================================================================

\begin{frame}[fragile]{Z-Score Formulas}
For counting stats (R, HR, RBI, TB, SB):
\begin{lstlisting}[language={}]
z_r = (runs / NUM_WEEKS) / SD_R
\end{lstlisting}

For strikeouts (lower is better):
\begin{lstlisting}[language={}]
z_so = -(strikeouts / NUM_WEEKS) / SD_SO
\end{lstlisting}

For OBP (rate stat, 9 hitters share team OBP):
\begin{lstlisting}[language={}]
z_obp = (obp - AVG_OBP) / 9 / SD_OBP
\end{lstlisting}

\notebox{The /9 on OBP accounts for one player contributing 1/9 of team OBP. Without it, OBP would be overweighted.}
\end{frame}

\begin{frame}[fragile]{PA Supplementation}
\begin{lstlisting}[language={}]
TARGET_PA = 600

if pa < TARGET_PA:
    gap_pa = TARGET_PA - pa
    runs = runs + gap_pa * REP_R_PER_PA
    hr = hr + gap_pa * REP_HR_PER_PA
    ...
    # OBP is weighted average
    obp = (pa * obp + gap_pa * REP_OBP) / TARGET_PA
    pa = TARGET_PA
\end{lstlisting}

\textbf{Purpose:} A player with 400 PA shouldn't look worse than 600 PA just due to fewer counting stats. We fill the gap with replacement-level production.
\end{frame}

\begin{frame}[fragile]{PA Normalization (normalize\_pa.py)}
\begin{lstlisting}[language={}]
# Scale The Bat stats to match DC playing time
scale = dc_pa[name] / thebat_pa

counting_stats = ['AB','H','1B','2B','3B','HR',
                  'R','RBI','BB','SO','SB','CS',...]

for stat in counting_stats:
    new_row[stat] = original * scale

# Rate stats (OBP, K%) unchanged
\end{lstlisting}

\textbf{Purpose:} Compare projection \textit{skill}, not playing time estimates. All systems use DC's PA projections.
\end{frame}

%=============================================================================
\section{UI and Player Arrays}
%=============================================================================

\begin{frame}[fragile]{Player Data Arrays (Lines 438-480)}
\begin{lstlisting}[language={}]
const HITTERS_THEBAT = [
  {"name":"Shohei Ohtani","type":"H","pa":679,
   "r":126,"hr":48,"rbi":119,"so":160,"tb":347,
   "sb":24,"obp":0.385},
  ...
];

const HITTERS_DC = [...];
const HITTERS_BATX = [...];

const PITCHERS = [
  {"name":"Tarik Skubal","type":"SP","gs":29.6,
   "ip_wk":7.03,"l_wk":0.259,"sv_wk":0.0,
   "hld_wk":0.0,"k_wk":8.48,"qs_wk":0.673,
   "er_wk":2.17,"wh_wk":6.854,...},
  ...
];
\end{lstlisting}

\warn{Hitter stats are season totals. Pitcher stats are already weekly.}
\end{frame}

\begin{frame}[fragile]{Projection System Toggle}
\begin{lstlisting}[language={}]
let currentProjection = 'thebat'; // default

function getHitters() {
  if (currentProjection === 'thebat')
    return HITTERS_THEBAT;
  if (currentProjection === 'batx')
    return HITTERS_BATX;
  return HITTERS_DC;
}

function switchProjection(value) {
  currentProjection = value;
  renderAll();
}
\end{lstlisting}

\notebox{PITCHERS array is shared across all projection systems (not toggled).}
\end{frame}

%=============================================================================
\section{Worked Example: Ram\'{i}rez Marginal Value}
%=============================================================================

\begin{frame}{Setup: Empty Roster}
\texttt{allTeams['My Team'].hitters} = 9 slots, all null.

\vspace{0.3cm}
\texttt{getHittingProjections} fills nulls with \texttt{HITTER\_REP}:
\begin{center}
\begin{tabular}{lr}
\toprule
Stat & Team Weekly Total \\
\midrule
R & $9 \times 73/25 = 26.28$ \\
HR & $9 \times 20/25 = 7.20$ \\
SB & $9 \times 9/25 = 3.24$ \\
OBP & $0.320$ \\
\bottomrule
\end{tabular}
\end{center}

These are compared to \texttt{HITTING\_AVG} to get win probabilities.
\end{frame}

\begin{frame}{Win Probabilities: Replacement Team}
\begin{center}
\begin{tabular}{lrrrr}
\toprule
Cat & My Team & Opp (AVG) & SD & P(win) \\
\midrule
R & 26.28 & 28.96 & 6.03 & 37.7\% \\
HR & 7.20 & 8.02 & 2.93 & 42.2\% \\
RBI & 25.92 & 27.86 & 6.72 & 41.9\% \\
SO & 48.24 & 50.11 & 7.45 & 57.0\% \\
TB & 80.64 & 88.87 & 15.94 & 35.8\% \\
SB & 3.24 & 4.74 & 2.57 & 34.0\% \\
OBP & 0.320 & 0.320 & 0.04 & 50.0\% \\
\bottomrule
\end{tabular}
\end{center}

\texttt{currentWins} = $\sum P = 2.99$
\end{frame}

\begin{frame}{Add Ram\'{i}rez to Slot 0}
Ram\'{i}rez's season line: 679 PA, 98 R, 30 HR, 94 RBI, 78 SO, 300 TB, 34 SB, .348 OBP

\vspace{0.3cm}
Team becomes 8 replacement + Ram\'{i}rez:
\begin{center}
\begin{tabular}{lrrr}
\toprule
Cat & Before & After & $\Delta$ \\
\midrule
R & 26.28 & 27.28 & +1.00 \\
HR & 7.20 & 7.60 & +0.40 \\
SO & 48.24 & 46.00 & $-2.24$ \\
SB & 3.24 & 4.24 & +1.00 \\
OBP & 0.320 & 0.323 & +0.003 \\
\bottomrule
\end{tabular}
\end{center}

\notebox{OBP shifts by $(0.348-0.320)/9 = 0.003$ because it's averaged across 9 hitters.}
\end{frame}

\begin{frame}{New Win Probabilities}
\begin{center}
\begin{tabular}{lrrrr}
\toprule
Cat & Old P & New P & $\Delta P$ \\
\midrule
R & 37.7\% & 42.2\% & +4.5\% \\
HR & 42.2\% & 46.0\% & +3.8\% \\
RBI & 41.9\% & 45.6\% & +3.6\% \\
SO & 57.0\% & 65.2\% & +8.1\% \\
TB & 35.8\% & 40.9\% & +5.1\% \\
SB & 34.0\% & 44.5\% & +10.5\% \\
OBP & 50.0\% & 52.2\% & +2.2\% \\
\midrule
\textbf{Total} & 2.99 & 3.36 & \textbf{+0.378} \\
\bottomrule
\end{tabular}
\end{center}

\texttt{marginalValue = 3.36 - 2.99 = 0.378}

This is what the UI shows as ``+MV'' for Ram\'{i}rez.
\end{frame}

\begin{frame}{Why SB and SO Dominate}
\begin{center}
\begin{tabular}{lrrr}
\toprule
Cat & Weekly $\Delta$ & SD & $\Delta P$ \\
\midrule
SB & +1.00 & 2.57 & +10.5\% \\
SO & $-2.24$ & 7.45 & +8.1\% \\
TB & +3.04 & 15.94 & +5.1\% \\
\bottomrule
\end{tabular}
\end{center}

\textbf{Key insight:} Marginal value $\propto \frac{\Delta}{\text{SD}}$

\begin{itemize}
    \item SB: $1.00 / 2.57 = 0.39$ (high leverage)
    \item TB: $3.04 / 15.94 = 0.19$ (low leverage)
\end{itemize}

Categories with small SD have outsized impact per unit.
\end{frame}

%=============================================================================
\section{Common Gotchas}
%=============================================================================

\begin{frame}{Things That Will Trip You Up}
\begin{enumerate}
    \item \textbf{Hitter stats are season totals}, pitcher stats are weekly

    \item \textbf{Empty slots auto-fill with replacement}---this is how ``vs replacement'' works

    \item \textbf{OBP divides by 9} in z-score calculation (one player = 1/9 of team OBP)

    \item \textbf{Replacement OBP is hardcoded} to 0.320 (not computed from cohort)

    \item \textbf{SP ip\_wk is already scaled} to 1.1 starts/week in PITCHERS array

    \item \textbf{ERA/WHIP are ratio stats}---RPs have tiny impact because they pitch few innings

    \item \textbf{Player arrays are embedded in HTML}---regenerating CSVs requires manual copy
\end{enumerate}
\end{frame}

\begin{frame}{SD Interpretation}
Two related but different metrics:

\vspace{0.3cm}
\textbf{1/SD = marginal leverage per unit}
\begin{itemize}
    \item Used for player valuation
    \item SB: $1/2.57 = 0.39$ (high leverage)
    \item K: $1/11.79 = 0.08$ (low leverage)
\end{itemize}

\vspace{0.3cm}
\textbf{CV = SD/Mean = category noise}
\begin{itemize}
    \item SB: $2.57/4.74 = 54\%$ (very noisy)
    \item SO: $7.45/50.11 = 15\%$ (stable)
\end{itemize}

\notebox{For marginal value, only absolute SD matters. CV tells you how luck-dependent a category is, but doesn't change the valuation formula.}
\end{frame}

%=============================================================================
\section{Feature History}
%=============================================================================

\begin{frame}{Changes Made (Chronological)}
\begin{enumerate}
    \item Base draft tool with UI and player data
    \item Marginal win probability calculation
    \item PA supplementation to 600 PA floor
    \item Projection toggle (The Bat vs Depth Charts)
    \item PA normalization across projection systems
    \item 300 PA minimum filter
    \item Replacement recalibration (ranks 155-175 cohort)
    \item OBP cap at league average (0.320)
    \item The BatX projection system added
\end{enumerate}

\vspace{0.3cm}
\notebox{Each feature should be documented here when added. Include: what changed, which files, any gotchas.}
\end{frame}

\begin{frame}{Quick Reference: Key Lines in draft\_tool.html}
\begin{center}
\begin{tabular}{lr}
\toprule
What & Lines \\
\midrule
HITTERS arrays & 438-480 \\
PITCHERS array & 480 \\
SD constants & 482-483 \\
AVG constants & 486-487 \\
Replacement constants & 489-510 \\
normalCDF / winProbability & 580-599 \\
getHittingProjections & 604-615 \\
getPitchingProjections & 617-690 \\
getExpectedWins & 692-720 \\
calculateMarginalValue & 724-753 \\
renderAvailablePlayers & 877-980 \\
\bottomrule
\end{tabular}
\end{center}

\warn{Line numbers may drift as code is edited. Use function names to search.}
\end{frame}

\end{document}
